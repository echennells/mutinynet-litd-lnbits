version: '3.8'

# This override file ensures volumes are created with correct permissions
# It uses a temporary init container that runs as root to fix permissions

services:
  volume-init:
    image: busybox
    user: root
    command: |
      sh -c "
        echo 'Checking volume directories...'
        for dir in .bitcoin .lnd .lit .tapd .faraday .loop .pool; do
          if [ ! -d /volumes/\$dir ]; then
            echo \"Creating /volumes/\$dir with proper ownership\"
            mkdir -p /volumes/\$dir
            chown 1000:1000 /volumes/\$dir
          else
            echo \"/volumes/\$dir already exists, preserving existing permissions\"
          fi
        done
        echo 'Volume check complete'
      "
    volumes:
      - ~/volumes:/volumes

  bitcoind:
    depends_on:
      volume-init:
        condition: service_completed_successfully

  lit-init:
    depends_on:
      volume-init:
        condition: service_completed_successfully

  lit:
    depends_on:
      volume-init:
        condition: service_completed_successfully
      bitcoind:
        condition: service_started
      lit-init:
        condition: service_completed_successfully